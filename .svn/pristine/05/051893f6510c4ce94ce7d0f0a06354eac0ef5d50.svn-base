!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","jquery-ui/sortable"],e):e(window.jQuery)}(function($){"use strict";function e(e,t,s){return e>t&&e<t+s}$.widget("mjs.nestedSortable",$.extend({},$.ui.sortable.prototype,{options:{disableParentChange:!1,doNotClear:!1,expandOnHover:700,isAllowed:function(){return!0},isTree:!1,listType:"ol",maxLevels:0,protectRoot:!1,rootID:null,rtl:!1,startCollapsed:!1,tabSize:20,branchClass:"mjs-nestedSortable-branch",collapsedClass:"mjs-nestedSortable-collapsed",disableNestingClass:"mjs-nestedSortable-no-nesting",errorClass:"mjs-nestedSortable-error",expandedClass:"mjs-nestedSortable-expanded",hoveringClass:"mjs-nestedSortable-hovering",leafClass:"mjs-nestedSortable-leaf",disabledClass:"mjs-nestedSortable-disabled"},_create:function(){var e=this,t;if(this.element.data("ui-sortable",this.element.data("mjs-nestedSortable")),!this.element.is(this.options.listType))throw t="nestedSortable: Please check that the listType option is set to your actual list type",new Error(t);this.options.isTree&&this.options.expandOnHover&&(this.options.tolerance="intersect"),$.ui.sortable.prototype._create.apply(this,arguments),this.options.isTree&&$(this.items).each(function(){var t=this.item,s=t.hasClass(e.options.collapsedClass),i=t.hasClass(e.options.expandedClass);t.children(e.options.listType).length?(t.addClass(e.options.branchClass),s||i||(e.options.startCollapsed?t.addClass(e.options.collapsedClass):t.addClass(e.options.expandedClass))):t.addClass(e.options.leafClass)})},_destroy:function(){return this.element.removeData("mjs-nestedSortable").removeData("ui-sortable"),$.ui.sortable.prototype._destroy.apply(this,arguments)},_mouseDrag:function(e){var t,s,i,o,l=this,r=this.options,n=!1,a=$(document),h,p,d,c,u,f,m,v,g,C,b,y;for(this.position=this._generatePosition(e),this.positionAbs=this._convertPositionTo("absolute"),this.lastPositionAbs||(this.lastPositionAbs=this.positionAbs),this.options.scroll&&(this.scrollParent[0]!==document&&"HTML"!==this.scrollParent[0].tagName?(this.overflowOffset.top+this.scrollParent[0].offsetHeight-e.pageY<r.scrollSensitivity?(n=this.scrollParent.scrollTop()+r.scrollSpeed,this.scrollParent.scrollTop(n)):e.pageY-this.overflowOffset.top<r.scrollSensitivity&&(n=this.scrollParent.scrollTop()-r.scrollSpeed,this.scrollParent.scrollTop(n)),this.overflowOffset.left+this.scrollParent[0].offsetWidth-e.pageX<r.scrollSensitivity?(n=this.scrollParent.scrollLeft()+r.scrollSpeed,this.scrollParent.scrollLeft(n)):e.pageX-this.overflowOffset.left<r.scrollSensitivity&&(n=this.scrollParent.scrollLeft()-r.scrollSpeed,this.scrollParent.scrollLeft(n))):(e.pageY-a.scrollTop()<r.scrollSensitivity?(n=a.scrollTop()-r.scrollSpeed,a.scrollTop(n)):$(window).height()-(e.pageY-a.scrollTop())<r.scrollSensitivity&&(n=a.scrollTop()+r.scrollSpeed,a.scrollTop(n)),e.pageX-a.scrollLeft()<r.scrollSensitivity?(n=a.scrollLeft()-r.scrollSpeed,a.scrollLeft(n)):$(window).width()-(e.pageX-a.scrollLeft())<r.scrollSensitivity&&(n=a.scrollLeft()+r.scrollSpeed,a.scrollLeft(n))),!1!==n&&$.ui.ddmanager&&!r.dropBehaviour&&$.ui.ddmanager.prepareOffsets(this,e)),this.positionAbs=this._convertPositionTo("absolute"),h=this.placeholder.offset().top,this.options.axis&&"y"===this.options.axis||(this.helper[0].style.left=this.position.left+"px"),this.options.axis&&"x"===this.options.axis||(this.helper[0].style.top=this.position.top+"px"),this.hovering=this.hovering?this.hovering:null,this.mouseentered=!!this.mouseentered&&this.mouseentered,function(){var e=this.placeholder.parent().parent();e&&e.closest(".ui-sortable").length&&(p=e)}.call(this),d=this._getLevel(this.placeholder),c=this._getChildLevels(this.helper),m=document.createElement(r.listType),t=this.items.length-1;t>=0;t--)if(s=this.items[t],i=s.item[0],(o=this._intersectsWithPointer(s))&&s.instance===this.currentContainer){if(-1!==i.className.indexOf(r.disabledClass))if(2===o){if((u=this.items[t+1])&&u.item.hasClass(r.disabledClass))continue}else if(1===o&&(f=this.items[t-1])&&f.item.hasClass(r.disabledClass))continue;if(v=1===o?"next":"prev",!(i===this.currentItem[0]||this.placeholder[v]()[0]===i||$.contains(this.placeholder[0],i)||"semi-dynamic"===this.options.type&&$.contains(this.element[0],i))){if(this.mouseentered||($(i).mouseenter(),this.mouseentered=!0),r.isTree&&$(i).hasClass(r.collapsedClass)&&r.expandOnHover&&(this.hovering||($(i).addClass(r.hoveringClass),this.hovering=window.setTimeout(function(){$(i).removeClass(r.collapsedClass).addClass(r.expandedClass),l.refreshPositions(),l._trigger("expand",e,l._uiHash())},r.expandOnHover))),this.direction=1===o?"down":"up","pointer"!==this.options.tolerance&&!this._intersectsWithSides(s))break;$(i).mouseleave(),this.mouseentered=!1,$(i).removeClass(r.hoveringClass),this.hovering&&window.clearTimeout(this.hovering),this.hovering=null,!r.protectRoot||this.currentItem[0].parentNode===this.element[0]&&i.parentNode!==this.element[0]?r.protectRoot||this._rearrange(e,s):this.currentItem[0].parentNode!==this.element[0]&&i.parentNode===this.element[0]?($(i).children(r.listType).length||(i.appendChild(m),r.isTree&&$(i).removeClass(r.leafClass).addClass(r.branchClass+" "+r.expandedClass)),g="down"===this.direction?$(i).prev().children(r.listType):$(i).children(r.listType),void 0!==g[0]&&this._rearrange(e,null,g)):this._rearrange(e,s),this._clearEmpty(i),this._trigger("change",e,this._uiHash());break}}if(function(){var e=this.placeholder.prev();C=e.length?e:null}.call(this),null!=C)for(;"li"!==C[0].nodeName.toLowerCase()||-1!==C[0].className.indexOf(r.disabledClass)||C[0]===this.currentItem[0]||C[0]===this.helper[0];){if(!C[0].previousSibling){C=null;break}C=$(C[0].previousSibling)}if(function(){var e=this.placeholder.next();b=e.length?e:null}.call(this),null!=b)for(;"li"!==b[0].nodeName.toLowerCase()||-1!==b[0].className.indexOf(r.disabledClass)||b[0]===this.currentItem[0]||b[0]===this.helper[0];){if(!b[0].nextSibling){b=null;break}b=$(b[0].nextSibling)}return this.beyondMaxLevels=0,null==p||null!=b||r.protectRoot&&p[0].parentNode==this.element[0]||!(r.rtl&&this.positionAbs.left+this.helper.outerWidth()>p.offset().left+p.outerWidth()||!r.rtl&&this.positionAbs.left<p.offset().left)?null==C||C.hasClass(r.disableNestingClass)||!(C.children(r.listType).length&&C.children(r.listType).is(":visible")||!C.children(r.listType).length)||r.protectRoot&&this.currentItem[0].parentNode===this.element[0]||!(r.rtl&&this.positionAbs.left+this.helper.outerWidth()<C.offset().left+C.outerWidth()-r.tabSize||!r.rtl&&this.positionAbs.left>C.offset().left+r.tabSize)?this._isAllowed(p,d,d+c):(this._isAllowed(C,d,d+c+1),C.children(r.listType).length||(C[0].appendChild(m),r.isTree&&C.removeClass(r.leafClass).addClass(r.branchClass+" "+r.expandedClass)),h&&h<=C.offset().top?C.children(r.listType).prepend(this.placeholder):C.children(r.listType)[0].appendChild(this.placeholder[0]),void 0!==p&&this._clearEmpty(p[0]),this._trigger("change",e,this._uiHash())):(p.after(this.placeholder[0]),y=!p.children(r.listItem).children("li:visible:not(.ui-sortable-helper)").length,r.isTree&&y&&p.removeClass(this.options.branchClass+" "+this.options.expandedClass).addClass(this.options.leafClass),void 0!==p&&this._clearEmpty(p[0]),this._trigger("change",e,this._uiHash())),this._contactContainers(e),$.ui.ddmanager&&$.ui.ddmanager.drag(this,e),this._trigger("sort",e,this._uiHash()),this.lastPositionAbs=this.positionAbs,!1},_mouseStop:function(e){this.beyondMaxLevels&&(this.placeholder.removeClass(this.options.errorClass),this.domPosition.prev?$(this.domPosition.prev).after(this.placeholder):$(this.domPosition.parent).prepend(this.placeholder),this._trigger("revert",e,this._uiHash())),$("."+this.options.hoveringClass).mouseleave().removeClass(this.options.hoveringClass),this.mouseentered=!1,this.hovering&&window.clearTimeout(this.hovering),this.hovering=null,this._relocate_event=e,this._pid_current=$(this.domPosition.parent).parent().attr("id"),this._sort_current=this.domPosition.prev?$(this.domPosition.prev).next().index():0,$.ui.sortable.prototype._mouseStop.apply(this,arguments)},_intersectsWithSides:function(t){var s=this.options.isTree?.8:.5,i=e(this.positionAbs.top+this.offset.click.top,t.top+t.height*s,t.height),o=e(this.positionAbs.top+this.offset.click.top,t.top-t.height*s,t.height),l=e(this.positionAbs.left+this.offset.click.left,t.left+t.width/2,t.width),r=this._getDragVerticalDirection(),n=this._getDragHorizontalDirection();return this.floating&&n?"right"===n&&l||"left"===n&&!l:r&&("down"===r&&i||"up"===r&&o)},_contactContainers:function(){this.options.protectRoot&&this.currentItem[0].parentNode===this.element[0]||$.ui.sortable.prototype._contactContainers.apply(this,arguments)},_clear:function(){var e,t;for($.ui.sortable.prototype._clear.apply(this,arguments),this._pid_current===this._uiHash().item.parent().parent().attr("id")&&this._sort_current===this._uiHash().item.index()||this._trigger("relocate",this._relocate_event,this._uiHash()),e=this.items.length-1;e>=0;e--)t=this.items[e].item[0],this._clearEmpty(t)},serialize:function(e){var t=$.extend({},this.options,e),s=this._getItemsAsjQuery(t&&t.connected),i=[];return $(s).each(function(){var e=($(t.item||this).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/),s=($(t.item||this).parent(t.listType).parent(t.items).attr(t.attribute||"id")||"").match(t.expression||/(.+)[-=_](.+)/);e&&i.push((t.key||e[1])+"["+(t.key&&t.expression?e[1]:e[2])+"]="+(s?t.key&&t.expression?s[1]:s[2]:t.rootID))}),!i.length&&t.key&&i.push(t.key+"="),i.join("&")},toHierarchy:function(e){function t(e){var i=($(e).attr(s.attribute||"id")||"").match(s.expression||/(.+)[-=_](.+)/),o,l=$(e).data();if(l.nestedSortableItem&&delete l.nestedSortableItem,i)return o={id:i[2]},o=$.extend({},o,l),$(e).children(s.listType).children(s.items).length>0&&(o.children=[],$(e).children(s.listType).children(s.items).each(function(){var e=t(this);o.children.push(e)})),o}var s=$.extend({},this.options,e),i=[];return $(this.element).children(s.items).each(function(){var e=t(this);i.push(e)}),i},toArray:function(e){function t(e,l,r){var n=r+1,a,h,p;if($(e).children(s.listType).children(s.items).length>0&&(l++,$(e).children(s.listType).children(s.items).each(function(){n=t($(this),l,n)}),l--),a=($(e).attr(s.attribute||"id")||"").match(s.expression||/(.+)[-=_](.+)/),l===i?h=s.rootID:(p=$(e).parent(s.listType).parent(s.items).attr(s.attribute||"id").match(s.expression||/(.+)[-=_](.+)/),h=p[2]),a){var d=$(e).children("div").data(),c=$.extend(d,{id:a[2],parent_id:h,depth:l,left:r,right:n});o.push(c)}return r=n+1}var s=$.extend({},this.options,e),i=s.startDepthCount||0,o=[],l=1;return s.excludeRoot||(o.push({item_id:s.rootID,parent_id:null,depth:i,left:l,right:2*($(s.items,this.element).length+1)}),l++),$(this.element).children(s.items).each(function(){l=t(this,i,l)}),o=o.sort(function(e,t){return e.left-t.left})},_clearEmpty:function(e){function t(e,t,s,i){i&&(t=[s,s=t][0]),$(e).removeClass(t).addClass(s)}var s=this.options,i=$(e).children(s.listType),o=i.has("li").length,l=s.doNotClear||o||s.protectRoot&&$(e)[0]===this.element[0];s.isTree&&t(e,s.branchClass,s.leafClass,l),l||(i.parent().removeClass(s.expandedClass),i.remove())},_getLevel:function(e){var t=1,s;if(this.options.listType)for(s=e.closest(this.options.listType);s&&s.length>0&&!s.is(".ui-sortable");)t++,s=s.parent().closest(this.options.listType);return t},_getChildLevels:function(e,t){var s=this,i=this.options,o=0;return t=t||0,$(e).children(i.listType).children(i.items).each(function(e,i){o=Math.max(s._getChildLevels(i,t+1),o)}),t?o+1:o},_isAllowed:function(e,t,s){var i=this.options,o=this.placeholder.closest(".ui-sortable").nestedSortable("option","maxLevels"),l=this.currentItem.parent().parent();i.disableParentChange&&(void 0!==e&&!l.is(e)||void 0===e&&l.is("li"))||!i.isAllowed(this.placeholder,e,this.currentItem)?(this.placeholder.addClass(i.errorClass),this.beyondMaxLevels=o<s&&0!==o?s-o:1):o<s&&0!==o?(this.placeholder.addClass(i.errorClass),this.beyondMaxLevels=s-o):(this.placeholder.removeClass(i.errorClass),this.beyondMaxLevels=0)}})),$.mjs.nestedSortable.prototype.options=$.extend({},$.ui.sortable.prototype.options,$.mjs.nestedSortable.prototype.options)});